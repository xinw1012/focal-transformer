# --------------------------------------------------------
# Focal Transformer
# Copyright (c) 2021 Microsoft
# Licensed under The MIT License [see LICENSE for details]
# Written by Jianwei Yang
# --------------------------------------------------------
from . import pyramid_transformer, conv_transformer, vision_longformer, vision_transformer
from .swin_transformer import SwinTransformer as swin
from .swin_transformer_v2 import SwinTransformer as swinv2
from .swin_transformer_add import SwinTransformer as swin_add
from .swin_transformer_mul import SwinTransformer as swin_mul
from .focal_transformer import FocalTransformer as focal
from .focal_transformer_moe_global_v3 import FocalTransformer as focal_moe_global_v3
from .focal_transformer_moe_global_v6 import FocalTransformer as focal_moe_global
from .focal_transformer_moe_global_v6_add import FocalTransformer as focal_moe_global_add
from .focal_transformer_moe_global_v6_smart import FocalTransformer as focal_moe_global_smart
from .focal_transformer_moe_global_v6_smart_unified import FocalTransformer as focal_moe_global_smart_unified
from .focal_transformer_moe_global_v6_smart_unified_routedv1 import FocalTransformer as focal_moe_global_smart_unified_routedv1
from .focal_transformer_moe_global_v6_smart_unified_routedv2 import FocalTransformer as focal_moe_global_smart_unified_routedv2
from .focal_transformer_moe_global_v6_smart_unified_routedv3 import FocalTransformer as focal_moe_global_smart_unified_routedv3
from .focal_transformer_moe_global_v6_smart_unified_routedv3plus import FocalTransformer as focal_moe_global_smart_unified_routedv3plus
from .focal_transformer_moe_global_v6_smart_unified_routedv5 import FocalTransformer as focal_moe_global_smart_unified_routedv5
from .focal_transformer_moe_global_v6_smart_unified_routedv6 import FocalTransformer as focal_moe_global_smart_unified_routedv6
from .focal_transformer_moe_global_v6_smart_unified_routedv7 import FocalTransformer as focal_moe_global_smart_unified_routedv7
from .focal_transformer_moe_global_v6_smart_unified_routedv8 import FocalTransformer as focal_moe_global_smart_unified_routedv8
from .focal_transformer_moe_global_v6_smart_unified_routedv9 import FocalTransformer as focal_moe_global_smart_unified_routedv9
from .focal_transformer_moe_global_v6_smart_unified_routedv10 import FocalTransformer as focal_moe_global_smart_unified_routedv10
from .focal_transformer_moe_global_v6_smart_unified_routedv11 import FocalTransformer as focal_moe_global_smart_unified_routedv11
from .focal_transformer_moe_global_v6_smart_unified_routedv12 import FocalTransformer as focal_moe_global_smart_unified_routedv12
from .focal_transformer_moe_global_v6_smart_unified_routedv13 import FocalTransformer as focal_moe_global_smart_unified_routedv13
from .focal_transformer_moe_global_v6_smart_unified_routedv14 import FocalTransformer as focal_moe_global_smart_unified_routedv14
from .focal_transformer_moe_global_v6_smart_unified_routedv15 import FocalTransformer as focal_moe_global_smart_unified_routedv15
from .focal_transformer_moe_global_v6_smart_unified_routedv16 import FocalTransformer as focal_moe_global_smart_unified_routedv16
from .focal_transformer_moe_global_v6_smart_unified_routedv17 import FocalTransformer as focal_moe_global_smart_unified_routedv17
from .focal_transformer_moe_global_v6_smart_unified_routedv18 import FocalTransformer as focal_moe_global_smart_unified_routedv18
from .focal_transformer_moe_global_v6_smart_unified_routedv19 import FocalTransformer as focal_moe_global_smart_unified_routedv19
from .focal_transformer_moe_global_v6_smart_unified_routedv20 import FocalTransformer as focal_moe_global_smart_unified_routedv20
from .focal_transformer_moe_global_v6_smart_unified_routedv21 import FocalTransformer as focal_moe_global_smart_unified_routedv21
from .focal_transformer_moe_global_v6_smart_unified_routedv22 import FocalTransformer as focal_moe_global_smart_unified_routedv22
from .focal_transformer_moe_global_v6_smart_unified_routedv23 import FocalTransformer as focal_moe_global_smart_unified_routedv23
from .focal_transformer_moe_global_v6_smart_unified_routedv24 import FocalTransformer as focal_moe_global_smart_unified_routedv24
from .focal_transformer_moe_global_v6_smart_unified_routedv25 import FocalTransformer as focal_moe_global_smart_unified_routedv25
from .focal_transformer_moe_global_v6_smart_unified_routedv26 import FocalTransformer as focal_moe_global_smart_unified_routedv26
from .focal_transformer_moe_global_v6_smart_unified_routedv27 import FocalTransformer as focal_moe_global_smart_unified_routedv27
from .focal_transformer_moe_global_v6_smart_unified_routedv28 import FocalTransformer as focal_moe_global_smart_unified_routedv28
from .focal_transformer_moe_global_v6_smart_unified_routedv29 import FocalTransformer as focal_moe_global_smart_unified_routedv29
from .focal_transformer_moe_global_v6_smart_unified_routedv30 import FocalTransformer as focal_moe_global_smart_unified_routedv30
from .focal_transformer_moe_global_v6_smart_unified_routedv31 import FocalTransformer as focal_moe_global_smart_unified_routedv31
from .focal_transformer_moe_global_v6_smart_unified_routedv32 import FocalTransformer as focal_moe_global_smart_unified_routedv32
from .focal_transformer_moe_global_v6_smart_unified_routedv33 import FocalTransformer as focal_moe_global_smart_unified_routedv33
from .focal_transformer_moe_global_v6_smart_unified_routedv34 import FocalTransformer as focal_moe_global_smart_unified_routedv34
from .focal_transformer_moe_global_v6_smart_unified_routedv35 import FocalTransformer as focal_moe_global_smart_unified_routedv35
from .focal_transformer_moe_global_v6_smart_unified_routedv36 import FocalTransformer as focal_moe_global_smart_unified_routedv36
from .focal_transformer_moe_global_v6_smart_unified_routedv37 import FocalTransformer as focal_moe_global_smart_unified_routedv37
from .focal_transformer_moe_global_v6_smart_unified_routedv39 import FocalTransformer as focal_moe_global_smart_unified_routedv39
from .focal_transformer_moe_global_v6_smart_unified_routedv40 import FocalTransformer as focal_moe_global_smart_unified_routedv40
from .focal_transformer_moe_global_v6_smart_unified_routedv41 import FocalTransformer as focal_moe_global_smart_unified_routedv41
from .focal_transformer_moe_global_v6_smart_unified_routedv42 import FocalTransformer as focal_moe_global_smart_unified_routedv42
from .focal_transformer_moe_global_v6_smart_unified_routedv43 import FocalTransformer as focal_moe_global_smart_unified_routedv43
from .focal_transformer_moe_global_v6_smart_unified_routedv44 import FocalTransformer as focal_moe_global_smart_unified_routedv44
from .focal_transformer_moe_global_v6_smart_unified_routedv45 import FocalTransformer as focal_moe_global_smart_unified_routedv45
from .focal_transformer_moe_global_v6_smart_unified_routedv46 import FocalTransformer as focal_moe_global_smart_unified_routedv46
from .focal_transformer_moe_global_v6_smart_unified_routedv47 import FocalTransformer as focal_moe_global_smart_unified_routedv47
from .focal_transformer_moe_global_v6_smart_unified_routedv49 import FocalTransformer as focal_moe_global_smart_unified_routedv49
from .focal_transformer_moe_global_v6_smart_unified_routedv50 import FocalTransformer as focal_moe_global_smart_unified_routedv50
from .focal_transformer_moe_global_v6_smart_unified_routedv51 import FocalTransformer as focal_moe_global_smart_unified_routedv51
from .focal_transformer_moe_global_v6_smart_unified_routedv53 import FocalTransformer as focal_moe_global_smart_unified_routedv53
from .focal_transformer_moe_global_v6_smart_unified_routedv54 import FocalTransformer as focal_moe_global_smart_unified_routedv54
from .focal_transformer_v2 import FocalTransformer as focal_xhead
from .focal_transformer_v3 import FocalTransformer as focal_route
from .focal_transformer_faster import FocalTransformer as focal_faster
from .focal_transformer_eccv import FocalTransformer as focal_eccv
from .focal_transformer_eccv_lrf import FocalTransformer as focal_eccv_lrf
from .focal_transformer_eccv_lrf_additive import FocalTransformer as focal_eccv_lrf_add
from .focal_transformer_eccv_lrf_top import FocalTransformer as focal_eccv_lrf_top
from .focal_transformer_eccv_lrf_nogp import FocalTransformer as focal_eccv_lrf_nogp
from .focal_transformer_eccv_lrf_noweight import FocalTransformer as focal_eccv_lrf_now
from .focal_transformer_eccv_lrf_dw import FocalTransformer as focal_eccv_lrf_dw
from .focal_transformer_eccv_lrf_m2sa import FocalTransformer as focal_eccv_lrf_m2sa
from .focal_transformer_eccv_lrf_m2sav2 import FocalTransformer as focal_eccv_lrf_m2sav2
from .focal_transformer_eccv_lrf_puresa import FocalTransformer as focal_eccv_lrf_puresa
from .focal_transformer_eccv_lrf_avgpool import FocalTransformer as focal_eccv_lrf_avgpool
from .focal_transformer_eccv_fonly import FocalTransformer as focal_eccv_fonly
from .focal_transformer_eccv_iso import FocalTransformer as focal_eccv_iso
from .dwnet import DWNet as dwnet

from timm.models import create_model
from . import poolformer

def build_model(config):
    model_type = config.MODEL.TYPE
    print(f"Creating model: {model_type}")

    if "focal" in model_type:
        model = eval(model_type)(
            img_size=config.DATA.IMG_SIZE,
            patch_size=config.MODEL.FOCAL.PATCH_SIZE,
            in_chans=config.MODEL.FOCAL.IN_CHANS,
            num_classes=config.MODEL.NUM_CLASSES,
            embed_dim=config.MODEL.FOCAL.EMBED_DIM,
            depths=config.MODEL.FOCAL.DEPTHS,
            num_heads=config.MODEL.FOCAL.NUM_HEADS,
            window_size=config.MODEL.FOCAL.WINDOW_SIZE,
            mlp_ratio=config.MODEL.FOCAL.MLP_RATIO,
            qkv_bias=config.MODEL.FOCAL.QKV_BIAS,
            qk_scale=config.MODEL.FOCAL.QK_SCALE,
            drop_rate=config.MODEL.DROP_RATE,
            drop_path_rate=config.MODEL.DROP_PATH_RATE,
            ape=config.MODEL.FOCAL.APE,
            patch_norm=config.MODEL.FOCAL.PATCH_NORM,
            use_shift=config.MODEL.FOCAL.USE_SHIFT, 
            expand_stages=config.MODEL.FOCAL.EXPAND_STAGES,
            expand_sizes=config.MODEL.FOCAL.EXPAND_SIZES, 
            expand_layer=config.MODEL.FOCAL.EXPAND_LAYER,         
            focal_pool=config.MODEL.FOCAL.FOCAL_POOL,     
            focal_stages=config.MODEL.FOCAL.FOCAL_STAGES, 
            focal_windows=config.MODEL.FOCAL.FOCAL_WINDOWS,                                                   
            focal_levels=config.MODEL.FOCAL.FOCAL_LEVELS,    
            focal_factors=config.MODEL.FOCAL.FOCAL_FACTORS, 
            focal_strides=config.MODEL.FOCAL.FOCAL_STRIDES, 
            focal_kernels=config.MODEL.FOCAL.FOCAL_KERNELS, 
            focal_shape=config.MODEL.FOCAL.FOCAL_SHAPE, 
            focal_topK=config.MODEL.FOCAL.FOCAL_TOPK, 
            focal_routing_topK=config.MODEL.FOCAL.FOCAL_ROUTING_TOPK, 
            focal_dilation=1, 
            use_route=config.MODEL.FOCAL.USE_ROUTE, 
            use_conv_embed=config.MODEL.FOCAL.USE_CONV_EMBED, 
            mute_fine_grain=config.MODEL.FOCAL.MUTE_FINE_GRAIN, 
            use_layerscale=config.MODEL.FOCAL.USE_LAYERSCALE, 
            use_pre_norm=config.MODEL.FOCAL.USE_PRE_NORM, 
            use_checkpoint=config.TRAIN.USE_CHECKPOINT
        )                
    elif "swin" in model_type:
        model = eval(model_type)(
            img_size=config.DATA.IMG_SIZE,
            patch_size=config.MODEL.FOCAL.PATCH_SIZE,
            in_chans=config.MODEL.FOCAL.IN_CHANS,
            num_classes=config.MODEL.NUM_CLASSES,
            embed_dim=config.MODEL.FOCAL.EMBED_DIM,
            depths=config.MODEL.FOCAL.DEPTHS,
            num_heads=config.MODEL.FOCAL.NUM_HEADS,
            window_size=config.MODEL.FOCAL.WINDOW_SIZE,
            mlp_ratio=config.MODEL.FOCAL.MLP_RATIO,
            qkv_bias=config.MODEL.FOCAL.QKV_BIAS,
            qk_scale=config.MODEL.FOCAL.QK_SCALE,
            drop_rate=config.MODEL.DROP_RATE,
            drop_path_rate=config.MODEL.DROP_PATH_RATE,
            ape=config.MODEL.FOCAL.APE,
            patch_norm=config.MODEL.FOCAL.PATCH_NORM,
            use_checkpoint=config.TRAIN.USE_CHECKPOINT
        )        
    elif "pvt" in model_type:
        model = create_model(
            model_type,
            pretrained=False,
            img_size=config.DATA.IMG_SIZE,
            num_classes=config.MODEL.NUM_CLASSES,
            drop_rate=config.MODEL.DROP_RATE,
            drop_path_rate=config.MODEL.DROP_PATH_RATE,
            drop_block_rate=None,
        )
    elif "cvt" in model_type:
        msvit_spec = config.MODEL.SPEC
        model = create_model(
            model_type,
            pretrained=False,
            num_classes=config.MODEL.NUM_CLASSES, 
            init=getattr(msvit_spec, 'INIT', 'trunc_norm'), 
            spec=msvit_spec, 
        )        
    elif "vil" in model_type:
        args = dict(
            norm_embed=config.MODEL.SPEC.NORM_EMBED,
            avg_pool=config.MODEL.SPEC.AVG_POOL,
        )
        args['arch'] = config.MODEL.SPEC.MSVIT.ARCH
        args['sharew'] = config.MODEL.SPEC.MSVIT.SHARE_W
        args['attn_type'] = config.MODEL.SPEC.MSVIT.ATTN_TYPE
        args['share_kv'] = config.MODEL.SPEC.MSVIT.SHARE_KV
        args['only_glo'] = config.MODEL.SPEC.MSVIT.ONLY_GLOBAL
        args['sw_exact'] = config.MODEL.SPEC.MSVIT.SW_EXACT
        args['ln_eps'] = config.MODEL.SPEC.MSVIT.LN_EPS
        args['mode'] = config.MODEL.SPEC.MSVIT.MODE

        model = create_model(
            model_type,
            pretrained=False,
            img_size=config.DATA.IMG_SIZE,
            drop_rate=config.MODEL.DROP_RATE,
            drop_path_rate=config.MODEL.DROP_PATH_RATE,
            num_classes=config.MODEL.NUM_CLASSES, 
            **args,
        )
    elif "vit" in model_type:
        model = create_model(
            model_type,
            pretrained=False,
            img_size=config.DATA.IMG_SIZE,
            num_classes=config.MODEL.NUM_CLASSES,
        )
    elif "resnet" in model_type:
        model = create_model(
            model_type,
            pretrained=False,
            num_classes=config.MODEL.NUM_CLASSES
        )
    elif "poolformer" in model_type:
         model = create_model(
             model_type, 
             pretrained=False, 
             num_classes=config.MODEL.NUM_CLASSES
         )
    elif "dwnet" in model_type:
        model = eval(model_type)(
            img_size=config.DATA.IMG_SIZE,
            patch_size=config.MODEL.DWNET.PATCH_SIZE,
            in_chans=config.MODEL.DWNET.IN_CHANS,
            num_classes=config.MODEL.NUM_CLASSES,
            embed_dim=config.MODEL.DWNET.EMBED_DIM,
            depths=config.MODEL.DWNET.DEPTHS,
            window_size=config.MODEL.DWNET.WINDOW_SIZE,
            mlp_ratio=config.MODEL.DWNET.MLP_RATIO,
            drop_rate=config.MODEL.DROP_RATE,
            drop_path_rate=config.MODEL.DROP_PATH_RATE,
            ape=config.MODEL.DWNET.APE,
            patch_norm=config.MODEL.DWNET.PATCH_NORM,
            use_checkpoint=config.TRAIN.USE_CHECKPOINT, 
            dynamic=False, 
            inhomogeneous=config.MODEL.DWNET.INHOMO, 
            inhomo_heads=config.MODEL.DWNET.INHOMO_HEADS
        )       
    else:
        model = create_model(
            model_type,
            pretrained=False,
            num_classes=config.MODEL.NUM_CLASSES
        )        
    return model
