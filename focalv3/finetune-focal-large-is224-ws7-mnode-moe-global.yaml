description: train clip model on google cc and sbu

target:
  service: amlk8s
  # name: ms-shared-v100
  name: itphyperdgx2cl2
  vc: hcrr07
  # name: itphyperdgx2cl1
  # vc: hai2
  # name: itpwus2v100cl
  # vc: gcrprojvc1
  # name: scus-v100-2
  # vc: Image_Languge_Pretraining
  # name: itplabrr1cl1
  # vc: resrchvc
  # name: itphyperdellcl1
  # vc: msrhyper

environment:
  registry: docker.io
  # image: jw2yang/video-pytorch1.7:v0.1
  image: leoxiao/pytorch:ubuntu18.04_torch1.9-cuda11.2-nccl_bootstrap_tag-deepspeed0.4.5
  # image: leoxiao/pytorch:ubuntu18.04_torch1.9-cuda10.2-nccl_bootstrap_tag-deepspeed0.4.5
  # image: amsword/setup:py36pt17u18cu11
  # image: pengchuanzhang/maskrcnn:ubuntu18-py3.7-cuda10.1-pytorch1.7
  # setup:
  # - ./azcopy_linux_amd64_10.12.1/azcopy cp "https://vlpdatasets.blob.core.windows.net/data/imagenet_zip?sv=2020-04-08&st=2021-09-29T06%3A46%3A05Z&se=2021-10-30T06%3A46%3A00Z&sr=c&sp=rl&sig=L87lyb5jDF0fyCJrZxk0v3GkyYjz7PTwBZ7%2B%2FlxZ2PI%3D" /tmp/datasets --recursive
  # - ln -s /tmp/datasets/imagenet_zip DATASET

# target:
#   service: amlk8s
#   name: msrredmondvc
#   vc: msrhyper

# environment:
#   image: amlt-aisc/deepspeed-0.4-pytorch-1.9.0-cuda11.3-a100

storage:
  test_data_storage:
    storage_account_name: vlpdatasets
    container_name: data
  model_storage:
    storage_account_name: projects4jw
    container_name: model
  model_storage2:
    storage_account_name: projects4hcl
    container_name: model

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: ./

search:
  job_template:
    name: finetune_{model_type}_{lr}_{min_lr}_{wd}_{depths}_{focal_levels}_{focal_windows}_{focal_factors}_{focal_strides}_{embed_dim}_{dpr}_pool{pool_method}_conv{use_conv_embed}_reusehead{reuse_head}_is{isize}_ws{wsize}
    sku: 2xG16
    aml_mpirun:
      process_count_per_node: 1
      # AML only supports: OpenMpi or IntelMpi
      communicator: "OpenMpi"
    command:
    - ulimit -n 4096
    - pip install timm==0.4.12 antialiased-cnns bcolz ftfy regex tqdm einops
    # - git clone https://github.com/NVIDIA/apex.git & cd apex & python setup.py install --cuda_ext --cpp_ext --user & cd ..
    - pip install opencv-python==4.4.0.46 termcolor==1.1.0 yacs==0.1.8
    - export MKL_SERVICE_FORCE_INTEL=1
    - MKL_THREADING_LAYER=GNU python -m launch --nnodes={nnodes} --nproc_per_node={ngpus} --master_port 12345 main.py 
      --data-path /mnt/test_data_storage/imagenet_zip/2012
      --zip 
      --resume /mnt/model_storage2/focalv7_large_chunk_0.2_0.001_on_in22k/large_chunk.yaml_conf~/run_3/best_model/model/default/model_state_dict.pt
      --batch-size {batch_size}
      --cfg configs/focal_large_patch4_window7_224.yaml 
      --opts 
        DATA.NUM_WORKERS 2 
        TRAIN.EPOCHS 30
        TRAIN.WARMUP_EPOCHS 5 
        AUG.MIXUP_PROB 0.0
        AUG.CUTMIX 0.0
        AUG.MIXUP 0.0
        TRAIN.WARMUP_LR 2e-8
        MODEL.FOCAL.USE_LAYERSCALE True
        TRAIN.WEIGHT_DECAY {wd}       
        DATA.IMG_SIZE {isize}
        TRAIN.BASE_LR {lr}         
        TRAIN.MIN_LR {min_lr}
        TRAIN.CLIP_GRAD {grad_clip} 
        TEST.CROP {test_crop}
        MODEL.REUSE_HEAD {reuse_head}
        MODEL.TYPE {model_type} 
        MODEL.FOCAL.WINDOW_SIZE {wsize}
        MODEL.DROP_PATH_RATE {dpr}
        MODEL.FOCAL.EMBED_DIM {embed_dim}
        MODEL.FOCAL.FOCAL_POOL {pool_method} 
        MODEL.FOCAL.FOCAL_WINDOWS {focal_windows}
        MODEL.FOCAL.DEPTHS {depths}
        MODEL.FOCAL.USE_CONV_EMBED {use_conv_embed} 
        MODEL.FOCAL.FOCAL_LEVELS {focal_levels}     
        MODEL.FOCAL.FOCAL_FACTORS {focal_factors}   
        MODEL.FOCAL.FOCAL_STRIDES {focal_strides}
    submit_args:
      container_args:
        shm_size: 2048g
  max_trials: 36
  type: grid          
  params:
    - name: nnodes
      spec: discrete
      values: [2]
    - name: ngpus
      spec: discrete
      values: [16]  
    - name: batch_size
      spec: discrete
      values: [16]
    - name: isize
      spec: discrete
      values: [224]
    - name: wsize
      spec: discrete
      values: [7]
    - name: model_type
      spec: discrete
      values: [
        'focal_moe_global_smart_unified_routedv46'
      ]      
    - name: pool_method
      spec: discrete
      values: ['conv']     
    - name: depths
      spec: discrete
      values: ['[2,2,18,2]']
    - name: embed_dim
      spec: discrete
      values: ['[192]']      
    - name: focal_levels
      spec: discrete
      values: ['[1,1,1,1]']
    - name: focal_factors
      spec: discrete
      values: ['[2,2,2,2]']
    - name: focal_strides
      spec: discrete
      values: ['[1,1,1,1]']
    - name: use_conv_embed
      spec: discrete
      values: [False]   
    - name: reuse_head
      spec: discrete
      values: [True]   
    - name: test_crop
      spec: discrete
      values: [False]                      
    - name: focal_windows
      spec: discrete
      values: ['[7,5,3,1]']
    - name: dpr
      spec: discrete
      values: [0.1]      
    - name: lr
      spec: discrete
      values: [1e-5]
    - name: min_lr
      spec: discrete
      values: [1e-7]    
    - name: wd
      spec: discrete
      values: [1e-8]
    - name: grad_clip
      spec: discrete
      values: [5.0]            